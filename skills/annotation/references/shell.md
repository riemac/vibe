# Shell/Bash 脚本注释规范

面向训练脚本、环境安装、自动化任务等 Bash 脚本。

## 文件头注释

每个脚本必须有文件头，包含：

```bash
#!/bin/bash
# <脚本名>: <一句话描述功能>
#
# 功能: <详细功能说明>
# 依赖: <需要预先安装的软件/环境>
# 用法: <如何调用>
# 示例: <具体调用示例>
#
# 作者: <name>
# 日期: <YYYY-MM-DD>
```

### 示例

```bash
#!/bin/bash
# train.sh: 启动 DRO-Grasp 模型训练
#
# 功能: 配置环境变量并启动训练脚本
# 依赖: conda 环境 env_dro，需先 `conda activate env_dro`
# 用法: ./train.sh [config_name] [--resume]
# 示例: 
#   ./train.sh default           # 使用默认配置
#   ./train.sh ablation --resume # 恢复消融实验
```

## 区块注释

将脚本分成逻辑区块：

```bash
# ==============================================================================
# 环境检查
# ==============================================================================

# 确保 CUDA 可用，否则训练会退回 CPU（极慢）
if ! nvidia-smi &> /dev/null; then
    echo "Error: CUDA not available" >&2
    exit 1
fi

# ==============================================================================
# 参数解析
# ==============================================================================

CONFIG=${1:-default}  # 配置名称，默认 "default"
RESUME=${2:-}         # 是否恢复训练

# ==============================================================================
# 主逻辑
# ==============================================================================
```

## 变量注释

### 魔法数字

```bash
BATCH_SIZE=32   # 消融实验最优，见论文 Table 2
LR=1e-4         # 初始学习率，配合 warmup 使用
NUM_WORKERS=8   # DataLoader workers，与 CPU 核心数匹配
```

### 环境变量

```bash
# CUDA 设备选择，多卡时用逗号分隔
export CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}

# PyTorch 内存分配器配置，减少显存碎片
export PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512
```

### 路径变量

```bash
# 项目根目录，所有路径基于此
PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# 输出目录，训练日志和 checkpoint 存放位置
OUTPUT_DIR="${PROJECT_ROOT}/outputs/${CONFIG}"
```

## 命令注释

### 为什么用这个命令

```bash
# 使用 rsync 而非 cp：支持断点续传和增量同步
rsync -avz --progress source/ dest/

# 用 find + xargs 而非 for 循环：处理大量文件时更高效
find . -name "*.py" -print0 | xargs -0 grep "TODO"
```

### 特殊参数说明

```bash
# --no-cache: 确保下载最新版本，绕过 pip 缓存
pip install --no-cache torch

# -u: 确保 Python 输出不缓冲，日志实时可见
python -u train.py
```

## 错误处理注释

```bash
# 遇到错误立即退出，避免后续命令在错误状态下运行
set -e

# 管道中任意命令失败则整体失败
set -o pipefail

# 使用未定义变量时报错
set -u
```

## 模板

```bash
#!/bin/bash
# <script_name>: <功能描述>
#
# 功能: <详细说明>
# 依赖: <环境要求>
# 用法: <调用方式>
# 示例: <具体示例>

set -euo pipefail

# ==============================================================================
# 配置
# ==============================================================================

# <变量说明>
VAR_NAME=value

# ==============================================================================
# 函数定义
# ==============================================================================

# <函数功能>
# 参数: $1 - <描述>
# 返回: <描述>
function_name() {
    local arg1="$1"
    # 实现
}

# ==============================================================================
# 主逻辑
# ==============================================================================

main() {
    # 实现
}

main "$@"
```
